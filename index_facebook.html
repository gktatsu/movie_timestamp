<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Live ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚¢ãƒ—ãƒª</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        :root {
            --primary-color: #FF4136;
            --secondary-color: #7FDBFF;
            --background-color: #FFDC00;
            --text-color: #111111;
            --border-color: #DDDDDD;
            --error-color: #85144b;
        }

        * {
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--background-color), #FF851B);
            color: var(--text-color);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo {
            font-size: 3rem;
            font-weight: 600;
            color: var(--primary-color);
            text-shadow: 2px 2px var(--secondary-color);
        }

        h1 {
            font-weight: 300;
            font-size: 2rem;
            margin-top: 0.5rem;
            color: var(--text-color);
        }

        .input-section {
            display: flex;
            margin-bottom: 2rem;
            gap: 1rem;
        }

        #youtubeLinkInput {
            flex-grow: 1;
            padding: 0.75rem;
            font-size: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        #youtubeLinkInput:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(255, 65, 54, 0.3);
        }

        button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        button:hover {
            background-color: #E7040F;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        button:active {
            transform: translateY(0);
        }

        #loadVideoButton {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }

        #loadVideoButton:hover {
            background-color: #39CCCC;
        }

        #player {
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            overflow: hidden;
        }

        #getTimestamp {
            display: block;
            width: 100%;
            margin-bottom: 2rem;
            background-color: #2ECC40;
        }

        #getTimestamp:hover {
            background-color: #01FF70;
        }

        #getTimestamp:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        #timestampEntries {
            list-style-type: none;
            padding: 0;
        }

        .timestamp-entry {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .timestamp-entry:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .timestamp-entry button {
            margin-right: 1rem;
            padding: 0.5rem 1rem;
            background-color: var(--secondary-color);
            color: var(--text-color);
        }

        .timestamp-entry button:hover {
            background-color: #39CCCC;
        }

        .timestamp-entry span {
            font-weight: bold;
            margin-right: 1rem;
        }

        .timestamp-entry input {
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .timestamp-entry input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(255, 65, 54, 0.3);
        }

        .timestamp-entry .delete-button {
            margin-left: 1rem;
            background-color: var(--error-color);
            color: white;
        }

        .timestamp-entry .delete-button:hover {
            background-color: #B10DC9;
        }

        #errorMessage {
            color: var(--error-color);
            margin-top: 1rem;
            font-weight: bold;
            text-align: center;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
        }

        #loadingIndicator {
            display: none;
            text-align: center;
            margin-top: 1rem;
            font-style: italic;
            color: var(--primary-color);
            font-weight: 600;
        }

        select {
            padding: 0.5rem;
            font-size: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            background-color: white;
            margin-bottom: 1rem;
            width: 100%;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(255, 65, 54, 0.3);
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        #endViewingButton {
            background-color: #3D9970;
            color: white;
            width: 100%;
            margin-top: 2rem;
        }

        #endViewingButton:hover {
            background-color: #2ECC40;
        }

        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }

            .input-section {
                flex-direction: column;
            }

            #youtubeLinkInput, #loadVideoButton {
                width: 100%;
            }

            .timestamp-entry {
                flex-wrap: wrap;
            }

            .timestamp-entry button, .timestamp-entry span {
                margin-bottom: 0.5rem;
            }

            .timestamp-entry input {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ğŸ“º</div>
            <h1>Facebook Live ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— ã‚¢ãƒ—ãƒª</h1>
        </div>
        <div class="input-section">
            <input type="text" id="facebookLiveUrlInput" placeholder="Facebook Liveå‹•ç”»URLã‚’å…¥åŠ›">
            <button id="loadFacebookLiveButton">ãƒ©ã‚¤ãƒ–ã‚’èª­ã¿è¾¼ã‚€</button>
        </div>
        <div id="errorMessage"></div>
        <div id="loadingIndicator">ãƒ©ã‚¤ãƒ–ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>

        <div class="player-wrapper">
            <div id="facebookPlayer"></div>
        </div>

        <label for="timeOffset">ä½•ç§’å‰ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ</label>
        <select id="timeOffset">
            <option value="0">ç¾åœ¨ã®æ™‚åˆ»</option>
            <option value="30">30ç§’å‰</option>
            <option value="60">1åˆ†å‰</option>
        </select>
        <button id="getTimestamp" disabled>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¨˜éŒ²</button>
        <label for="sortOrder">ä¸¦ã³é †</label>
        <select id="sortOrder">
            <option value="newest">æ–°ã—ã„é †</option>
            <option value="oldest">å¤ã„é †</option>
        </select>
        <ul id="timestampEntries"></ul>

        <!-- ã‚¨ã‚¯ã‚»ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ -->
        <label for="importFile">ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å¾©å…ƒ</label>
        <input type="file" id="importFile" accept=".xlsx">
        <button id="importExcelButton">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>

        <button id="endViewingButton" disabled>è¦–è´çµ‚äº† & ã‚¨ã‚¯ã‚»ãƒ«å‡ºåŠ›</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        let player;
        let videoUrl = '';
        let currentVideoTitle = '';
        let currentVideoUrl = '';
        let timestamps = [];

        // Facebook Liveã‚’èª­ã¿è¾¼ã‚€
        function loadFacebookLivePlayer(url) {
            const iframe = document.createElement('iframe');
            iframe.src = `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(url)}&show_text=0&width=560&height=315`;
            iframe.width = "100%";
            iframe.height = "480";
            iframe.allowFullscreen = true;
            iframe.frameborder = "0";
            document.getElementById('facebookPlayer').appendChild(iframe);
        }

        // Facebook Liveã®URLã‚’èª­ã¿è¾¼ã‚€
        document.getElementById('loadFacebookLiveButton').addEventListener('click', function() {
            const liveUrl = document.getElementById('facebookLiveUrlInput').value;
            if (liveUrl) {
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('loadingIndicator').style.display = 'block';
                videoUrl = liveUrl;

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¦ãƒ­ãƒ¼ãƒ‰
                loadFacebookLivePlayer(videoUrl);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('getTimestamp').disabled = false;
                document.getElementById('endViewingButton').disabled = false;

                // Facebook APIã‚’ä½¿ã£ã¦ãƒ©ã‚¤ãƒ–ã‚¹ãƒˆãƒªãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—
                getFacebookLiveStreamInfo(videoUrl);
            } else {
                document.getElementById('errorMessage').textContent = 'Facebook Liveã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                document.getElementById('errorMessage').style.display = 'block';
            }
        });

        // Facebook APIã‚’ä½¿ã£ã¦å‹•ç”»æƒ…å ±ã‚’å–å¾—
        function getFacebookLiveStreamInfo(url) {
            const accessToken = 'YOUR_FACEBOOK_ACCESS_TOKEN'; // ã“ã“ã«Facebookã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›
            const videoId = extractFacebookVideoId(url);

            fetch(`https://graph.facebook.com/${videoId}?fields=title&access_token=${accessToken}`)
            .then(response => response.json())
            .then(data => {
                currentVideoTitle = data.title || 'No title found';
                currentVideoUrl = url;
            })
            .catch(error => {
                console.error('Error fetching Facebook stream data:', error);
            });
        }

        // Facebookå‹•ç”»ã®IDã‚’æŠ½å‡º
        function extractFacebookVideoId(url) {
            const match = url.match(/videos\/([0-9]+)/);
            return match ? match[1] : null;
        }

        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—è¨˜éŒ²æ©Ÿèƒ½ï¼ˆFacebookç”¨ï¼‰
        document.getElementById('getTimestamp').addEventListener('click', function() {
            const currentTime = Math.floor((new Date()).getTime() / 1000); // ç¾åœ¨ã®UNIXæ™‚é–“ã‚’ç§’ã§å–å¾—
            const offset = parseInt(document.getElementById('timeOffset').value, 10);
            let targetTime = currentTime - offset;

            const formattedTime = formatTime(targetTime);
            const timestampEntries = document.getElementById('timestampEntries');

            const li = document.createElement('li');
            li.className = 'timestamp-entry';
            li.innerHTML = `
                <button onclick="seekTo(${targetTime})">å†ç”Ÿ</button>
                <span>${formattedTime}</span>
                <input type="text" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›">
                <button class="delete-button" onclick="deleteTimestamp(this)">å‰Šé™¤</button>
            `;

            timestamps.push({
                time: formattedTime,
                videoTitle: currentVideoTitle,
                videoUrl: currentVideoUrl,
                comment: ''
            });

            const sortOrder = document.getElementById('sortOrder').value;
            if (sortOrder === 'newest') {
                timestampEntries.insertBefore(li, timestampEntries.firstChild);
            } else {
                timestampEntries.appendChild(li);
            }
        });

        // æ™‚é–“ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatTime(time) {
            const minutes = Math.floor(time / 60);
            const seconds = Math.floor(time % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Facebookå‹•ç”»ã®ç‰¹å®šã®æ™‚é–“ã«ã‚·ãƒ¼ã‚¯ï¼ˆæ³¨: Facebookã®å‹•ç”»ã‚·ãƒ¼ã‚¯ã¯APIã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å ´åˆã‚‚ã‚ã‚‹ï¼‰
        function seekTo(time) {
            alert(`æŒ‡å®šã•ã‚ŒãŸæ™‚é–“ ${formatTime(time)} ã«ç§»å‹•ã—ã¾ã™ãŒã€Facebookã®IFrameãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã¯ã‚·ãƒ¼ã‚¯æ“ä½œãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚`);
        }

        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å‰Šé™¤æ©Ÿèƒ½
        function deleteTimestamp(element) {
            const li = element.parentElement;
            li.remove();
        }

        // ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜æ©Ÿèƒ½
        function saveToExcel() {
            const timestampEntries = document.querySelectorAll('.timestamp-entry');
            const data = [];

            // å‹•ç”»æƒ…å ±ã‚’å–å¾—ã—ã¦ã‹ã‚‰æŒ¿å…¥
            if (timestamps.length > 0) {
                const latestVideoTitle = timestamps[timestamps.length - 1].videoTitle;
                const latestVideoUrl = timestamps[timestamps.length - 1].videoUrl;

                data.push({ A: 'ã‚¿ã‚¤ãƒˆãƒ«', B: latestVideoTitle });
                data.push({ A: 'URL', B: latestVideoUrl });
            } else {
                data.push({ A: 'ã‚¿ã‚¤ãƒˆãƒ«', B: currentVideoTitle });
                data.push({ A: 'URL', B: currentVideoUrl });
            }

            data.push({ A: 'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—', B: 'ã‚³ãƒ¡ãƒ³ãƒˆ' });

            // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŒ¿å…¥
            timestampEntries.forEach((entry, index) => {
                const time = entry.querySelector('span').innerText;
                const comment = entry.querySelector('input').value;

                timestamps[index].comment = comment;

                data.push({ A: time, B: comment });
            });

            // ã‚·ãƒ¼ãƒˆä½œæˆ
            const ws = XLSX.utils.json_to_sheet(data, { header: ['A', 'B'], skipHeader: true });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Timestamps');

            // ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
            XLSX.writeFile(wb, 'timestamps.xlsx');
        }

        // ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function importExcel() {
            const fileInput = document.getElementById('importFile').files[0];
            if (!fileInput) {
                alert("ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheet = workbook.Sheets['Timestamps'];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                currentVideoTitle = rows[0][1]; // B1: å‹•ç”»ã®ã‚¿ã‚¤ãƒˆãƒ«
                currentVideoUrl = rows[1][1]; // B2: å‹•ç”»ã®URL
                videoId = extractFacebookVideoId(currentVideoUrl);

                document.getElementById('facebookLiveUrlInput').value = currentVideoUrl;
                loadFacebookLivePlayer(currentVideoUrl);

                resetTimestamps();
                for (let i = 3; i < rows.length; i++) {
                    const time = rows[i][0];
                    const comment = rows[i][1];
                    addRestoredTimestamp(time, comment);
                }
            };
            reader.readAsArrayBuffer(fileInput);
        }

        // å¾©å…ƒã•ã‚ŒãŸã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¡¨ç¤ºã™ã‚‹
        function addRestoredTimestamp(time, comment) {
            const timestampEntries = document.getElementById('timestampEntries');

            const li = document.createElement('li');
            li.className = 'timestamp-entry';
            li.innerHTML = `
                <button onclick="seekTo(${parseTime(time)})">å†ç”Ÿ</button>
                <span>${time}</span>
                <input type="text" value="${comment}">
                <button class="delete-button" onclick="deleteTimestamp(this)">å‰Šé™¤</button>
            `;

            timestamps.push({
                time: time,
                videoTitle: currentVideoTitle,
                videoUrl: currentVideoUrl,
                comment: comment
            });

            const sortOrder = document.getElementById('sortOrder').value;
            if (sortOrder === 'newest') {
                timestampEntries.insertBefore(li, timestampEntries.firstChild);
            } else {
                timestampEntries.appendChild(li);
            }
        }

        // æ™‚é–“ã‚’åˆ†:ç§’å½¢å¼ã‹ã‚‰ç§’æ•°ã«å¤‰æ›
        function parseTime(timeString) {
            const [minutes, seconds] = timeString.split(':').map(Number);
            return minutes * 60 + seconds;
        }

        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ãƒªã‚»ãƒƒãƒˆ
        function resetTimestamps() {
            document.getElementById('timestampEntries').innerHTML = '';
            timestamps = [];
        }
    </script>
</body>
</html>
